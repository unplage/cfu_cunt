<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èŒè½è®¡æ•°åŠ©æ‰‹ï¼ˆçœŸÂ·è®¡æ•°ç‰ˆï¼‰</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: #f8fafc; }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 { color: #1d4ed8; text-align: center; }
    .controls { text-align: center; margin: 20px 0; }
    button {
      padding: 12px 24px;
      font-size: 16px;
      background: #1d4ed8;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 0 8px;
    }
    button:hover { background: #1e40af; }
    #canvas {
      display: block;
      max-width: 100%;
      margin: 20px auto;
      border: 1px solid #e2e8f0;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .result {
      background: #f0f9ff;
      border-radius: 8px;
      padding: 16px;
      margin: 20px 0;
      text-align: center;
    }
    .count { font-size: 28px; font-weight: bold; color: #1d4ed8; }
    .log { 
      font-family: monospace; 
      font-size: 13px; 
      background: #f1f5f9; 
      padding: 12px; 
      border-radius: 6px; 
      white-space: pre-wrap; 
      margin-top: 15px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>ğŸ”¬ èŒè½è®¡æ•°åŠ©æ‰‹ï¼ˆçœŸÂ·è®¡æ•°ç‰ˆï¼‰</h1>
  <p>âœ… çº¯ JS å®ç°ï½œâœ… æ— éœ€ç½‘ç»œï½œâœ… ä¸­å¿ƒè“ç‚¹æ ‡è®°ï½œâœ… é€‚é…ä»»æ„å¹³æ¿</p>

  <div class="controls">
    <button id="btn-upload">ğŸ“¤ ä¸Šä¼ å›¾åƒ</button>
    <button id="btn-demo">ğŸ§ª åŠ è½½ç¤ºä¾‹å›¾ï¼ˆ309èŒè½ï¼‰</button>
  </div>

  <div class="result">
    <div>æ£€æµ‹èŒè½æ•°ï¼š<span id="count" class="count">0</span></div>
    <div>çŠ¶æ€ï¼š<span id="status">ç­‰å¾…ä¸Šä¼ </span></div>
  </div>

  <canvas id="canvas" height="500"></canvas>
  <div class="log" id="log">æ—¥å¿—ï¼šå‡†å¤‡å°±ç»ª...</div>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const countEl = document.getElementById('count');
const statusEl = document.getElementById('status');
const logEl = document.getElementById('log');

function log(msg) {
  logEl.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n${logEl.textContent}`;
}

// ===== æ ¸å¿ƒï¼šçº¯ JS èŒè½è®¡æ•°ç®—æ³• =====
function countColonies(imgData, width, height) {
  // 1. è½¬ç°åº¦ï¼ˆLumaï¼‰
  const gray = new Float32Array(width * height);
  for (let i = 0; i < imgData.length; i += 4) {
    const r = imgData[i], g = imgData[i+1], b = imgData[i+2];
    const y = 0.299*r + 0.587*g + 0.114*b;
    gray[i/4] = y;
  }

  // 2. å±€éƒ¨è‡ªé€‚åº”é˜ˆå€¼ï¼ˆSauvolaï¼Œç®€åŒ–ç‰ˆï¼šçª—å£ 21x21ï¼Œk=0.2ï¼‰
  const thresh = new Uint8Array(width * height);
  const windowSize = 21;
  const half = Math.floor(windowSize / 2);
  const k = 0.2;

  for (let y = 0; y < height; y++) {
    for (let x = 0; x < width; x++) {
      let sum = 0, sumSq = 0, count = 0;
      for (let dy = -half; dy <= half; dy++) {
        for (let dx = -half; dx <= half; dx++) {
          const nx = x + dx, ny = y + dy;
          if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
            const idx = ny * width + nx;
            const val = gray[idx];
            sum += val;
            sumSq += val * val;
            count++;
          }
        }
      }
      if (count === 0) continue;
      const mean = sum / count;
      const std = Math.sqrt(sumSq / count - mean * mean);
      const localThresh = mean * (1 - k * (std / 255 - 1));
      thresh[y * width + x] = gray[y * width + x] > localThresh ? 1 : 0;
    }
  }

  // 3. è¿é€šåŸŸæ ‡è®°ï¼ˆ4é‚»åŸŸï¼Œå¸¦è´¨å¿ƒè®¡ç®—ï¼‰
  const labelMap = new Int32Array(width * height).fill(-1);
  const regions = []; // [{area, sumX, sumY, minx, miny, maxx, maxy}, ...]
  let currentLabel = 1;

  for (let y = 0; y < height; y++) {
    for (let x = 0; x < width; x++) {
      const idx = y * width + x;
      if (thresh[idx] === 0 || labelMap[idx] !== -1) continue;

      // æ³›æ´ªå¡«å……
      const stack = [[x, y]];
      let area = 0;
      let sumX = 0, sumY = 0;
      let minX = x, minY = y, maxX = x, maxY = y;

      while (stack.length) {
        const [cx, cy] = stack.pop();
        const i = cy * width + cx;
        if (i < 0 || i >= width*height || labelMap[i] !== -1 || thresh[i] === 0) continue;
        
        labelMap[i] = currentLabel;
        area++;
        sumX += cx;
        sumY += cy;
        minX = Math.min(minX, cx);
        minY = Math.min(minY, cy);
        maxX = Math.max(maxX, cx);
        maxY = Math.max(maxY, cy);

        stack.push([cx+1, cy], [cx-1, cy], [cx, cy+1], [cx, cy-1]);
      }

      // è¿‡æ»¤ï¼šé¢ç§¯ 35~800 åƒç´ ï¼ˆå…¸å‹èŒè½å¤§å°ï¼‰
      if (area >= 35 && area <= 800) {
        regions.push({
          area,
          cx: sumX / area,
          cy: sumY / area,
          minX, minY, maxX, maxY
        });
      }
      currentLabel++;
    }
  }

  // 4. è¿”å›ä¸­å¿ƒåæ ‡æ•°ç»„
  const centers = regions.map(r => [r.cx, r.cy]);
  return { count: centers.length, centers };
}

// ===== å¤„ç†å›¾åƒå‡½æ•° =====
async function processImage(file) {
  statusEl.textContent = "ğŸ”„ æ­£åœ¨å¤„ç†å›¾åƒ...";
  log("å¼€å§‹å¤„ç†...");

  const img = new Image();
  img.src = URL.createObjectURL(file);
  await new Promise(r => img.onload = r);

  // è®¾ç½®ç”»å¸ƒå°ºå¯¸
  canvas.width = img.width;
  canvas.height = img.height;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(img, 0, 0);

  // è·å–åƒç´ æ•°æ®
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const { count, centers } = countColonies(imageData.data, canvas.width, canvas.height);

  // ç»˜åˆ¶è“ç‚¹æ ‡è®°
  ctx.fillStyle = 'rgba(30, 144, 255, 0.95)';
  ctx.strokeStyle = '#fff';
  ctx.lineWidth = 1;
  centers.forEach(([x, y]) => {
    ctx.beginPath();
    ctx.arc(x, y, 3, 0, Math.PI * 2);
    ctx.fill();
    ctx.stroke();
  });

  // æ›´æ–° UI
  countEl.textContent = count;
  statusEl.textContent = count > 0 
    ? `âœ… æ£€æµ‹åˆ° ${count} ä¸ªèŒè½` 
    : "âš ï¸ æœªæ£€æµ‹åˆ°èŒè½ï¼ˆè¯·æ£€æŸ¥å›¾åƒè´¨é‡ï¼‰";
  
  log(`å®Œæˆï¼æ£€å‡º ${count} ä¸ªèŒè½ï¼Œä¸­å¿ƒåæ ‡æ•°: ${centers.length}`);
}

// ===== ç¤ºä¾‹å›¾ï¼ˆ309èŒè½æ ‡å‡†å›¾ base64ï¼‰=====
const DEMO_IMAGE_BASE64 = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEhMUFBcXFhYaGhgaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwaGhwa
