<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>èŒè½è®¡æ•°å™¨ Â· ç²¾å‡†ç‰ˆ</title>
    
    <!-- OpenCV.js -->
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady();"></script>
    
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --roi-color: rgba(255, 215, 0, 0.3);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }
        
        .splash { position: fixed; inset: 0; background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s; }
        .splash.hidden { opacity: 0; pointer-events: none; }
        .splash-icon { font-size: 100px; margin-bottom: 20px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-20px)} }
        .splash-text { font-size: 1.8rem; font-weight: 700; margin-bottom: 10px; }
        .splash-subtitle { color: var(--text-muted); margin-bottom: 30px; }
        .loading-bar { width: 200px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; overflow: hidden; }
        .loading-progress { height: 100%; background: var(--primary); width: 0%; animation: loading 2s ease-in-out infinite; }
        @keyframes loading { 0%{width:0%;margin-left:0%} 50%{width:50%;margin-left:25%} 100%{width:0%;margin-left:100%} }
        
        .app { max-width: 100vw; min-height: 100vh; display: flex; flex-direction: column; }
        header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); padding: 20px; text-align: center; box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3); position: sticky; top: 0; z-index: 100; }
        h1 { font-size: 1.6rem; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .version-badge { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; }
        
        main { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 20px; max-width: 1200px; margin: 0 auto; width: 100%; }
        
        .upload-card { background: var(--card); border-radius: 24px; padding: 40px 30px; text-align: center; border: 2px dashed var(--secondary); transition: all 0.3s; cursor: pointer; }
        .upload-card:hover, .upload-card.active { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); transform: translateY(-2px); }
        .upload-icon { font-size: 72px; margin-bottom: 20px; opacity: 0.9; }
        .upload-title { font-size: 1.4rem; margin-bottom: 10px; font-weight: 600; }
        .upload-subtitle { color: var(--text-muted); margin-bottom: 30px; font-size: 0.95rem; }
        .upload-tips { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 25px; }
        .tip-item { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: var(--text-muted); background: var(--bg); padding: 6px 12px; border-radius: 20px; }
        .btn-group { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .btn { padding: 14px 28px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover { background: #475569; }
        input[type="file"] { display: none; }
        
        .viewer { display: none; flex-direction: column; gap: 20px; animation: fadeIn 0.5s; }
        .viewer.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .control-panel { background: var(--card); border-radius: 20px; padding: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .control-section { display: flex; flex-direction: column; gap: 12px; }
        .section-title { font-size: 0.9rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .slider-group { display: flex; flex-direction: column; gap: 8px; }
        .slider-header { display: flex; justify-content: space-between; align-items: center; }
        .slider-label { font-size: 0.9rem; }
        .slider-value { background: var(--bg); padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; color: var(--primary); min-width: 40px; text-align: center; }
        input[type="range"] { width: 100%; height: 6px; -webkit-appearance: none; background: var(--bg); border-radius: 3px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: var(--primary); border-radius: 50%; cursor: pointer; transition: transform 0.2s; }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        
        select { width: 100%; padding: 8px; border-radius: 6px; background: var(--bg); color: var(--text); border: 1px solid var(--secondary); font-size: 0.9rem; }
        
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-small { padding: 10px 16px; font-size: 0.85rem; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--secondary); color: var(--text); }
        
        .mode-indicator { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: rgba(59, 130, 246, 0.2); color: var(--primary); border-radius: 20px; font-size: 0.9rem; font-weight: 600; }
        .mode-indicator.manual { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .mode-indicator.roi { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        
        .image-wrapper { position: relative; background: var(--card); border-radius: 20px; overflow: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.4); max-height: 70vh; }
        .canvas-container { position: relative; display: inline-block; min-width: 100%; }
        #mainCanvas { display: block; width: auto; height: auto; background: #1e293b; max-width: none; }
        .overlay-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        .roi-marker { position: absolute; border: 3px solid gold; border-radius: 50%; background: var(--roi-color); pointer-events: none; box-shadow: 0 0 0 2px rgba(0,0,0,0.3); display: none; }
        
        .colony-marker { position: absolute; transform: translate(-50%, -50%); pointer-events: auto; cursor: pointer; z-index: 10; transition: all 0.2s; }
        .marker-center { width: 6px; height: 6px; background: #00ff88; border: 1px solid white; border-radius: 50%; box-shadow: 0 1px 4px rgba(0,0,0,0.5); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .marker-circle { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 2px solid #ff4757; border-radius: 50%; opacity: 0.7; }
        .colony-marker:hover { z-index: 20; transform: translate(-50%, -50%) scale(1.3); }
        .colony-marker:hover .marker-center { background: #ff4757; }
        .colony-marker.manual .marker-center { background: #ffd700; }
        .colony-marker.manual .marker-circle { border-color: #ffd700; }
        .marker-tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: white; padding: 6px 10px; border-radius: 6px; font-size: 11px; white-space: nowrap; opacity: 0; transition: opacity 0.2s; pointer-events: none; margin-bottom: 5px; z-index: 30; }
        .colony-marker:hover .marker-tooltip { opacity: 1; }
        
        .stats-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .stat-box { background: var(--card); border-radius: 16px; padding: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1); transition: transform 0.2s; }
        .stat-box:hover { transform: translateY(-2px); border-color: var(--primary); }
        .stat-number { font-size: 2.2rem; font-weight: 700; color: var(--primary); display: block; line-height: 1; }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); margin-top: 8px; }
        .stat-box.success .stat-number { color: var(--success); }
        .stat-box.warning .stat-number { color: var(--warning); }
        .stat-box.info .stat-number { color: var(--info); }
        
        .loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 9998; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 60px; height: 60px; border: 4px solid rgba(59, 130, 246, 0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 20px; font-size: 1.1rem; color: var(--text); }
        .loading-subtext { margin-top: 10px; font-size: 0.9rem; color: var(--text-muted); }
        
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--card); color: var(--text); padding: 16px 24px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); opacity: 0; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); z-index: 10000; display: flex; align-items: center; gap: 10px; font-weight: 500; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .algo-info { background: rgba(59, 130, 246, 0.1); border-left: 4px solid var(--primary); padding: 12px 16px; border-radius: 0 8px 8px 0; font-size: 0.85rem; color: var(--text-muted); }
        .param-tip { font-size: 0.75rem; color: var(--success); margin-top: 4px; }
        
        @media (max-width: 768px) { h1 { font-size: 1.3rem; } .upload-title { font-size: 1.2rem; } .control-panel { grid-template-columns: 1fr; } .stats-panel { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <div class="splash" id="splash">
        <div class="splash-icon">ğŸ”¬</div>
        <div class="splash-text">èŒè½è®¡æ•°å™¨ Â· ç²¾å‡†ç‰ˆ</div>
        <div class="splash-subtitle">è‡ªé€‚åº”äº®åº¦ + å¤šç‰¹å¾éªŒè¯</div>
        <div class="loading-bar"><div class="loading-progress"></div></div>
    </div>
    
    <div class="app">
        <header>
            <h1><span>ğŸ”¬</span><span>èŒè½è®¡æ•°å™¨ Pro</span><span class="version-badge">v5.0</span></h1>
        </header>
        
        <main>
            <div class="upload-card" id="uploadCard">
                <div class="upload-icon">ğŸ“¤</div>
                <div class="upload-title">æ‹–æ”¾å›¾ç‰‡æˆ–ç‚¹å‡»ä¸Šä¼ </div>
                <div class="upload-subtitle">JPG / PNG / WEBP</div>
                <div class="upload-tips">
                    <div class="tip-item"><span>âš«</span><span>é»‘è‰²èƒŒæ™¯æœ€ä½³</span></div>
                    <div class="tip-item"><span>ğŸ’¡</span><span>å…‰çº¿å‡åŒ€</span></div>
                    <div class="tip-item"><span>ğŸ¯</span><span>å¯ä½¿ç”¨ROI</span></div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()"><span>ğŸ“</span><span>é€‰æ‹©æ–‡ä»¶</span></button>
                    <button class="btn btn-secondary" onclick="document.getElementById('cameraInput').click()"><span>ğŸ“·</span><span>æ‹ç…§</span></button>
                </div>
                <input type="file" id="fileInput" accept="image/*">
                <input type="file" id="cameraInput" accept="image/*" capture="environment">
            </div>
            
            <div class="viewer" id="viewer">
                <div class="control-panel">
                    <div class="control-section">
                        <div class="section-title">âš™ï¸ Houghåœ†æ£€æµ‹</div>
                        <div class="slider-group">
                            <div class="slider-header"><span class="slider-label">ç´¯åŠ å™¨é˜ˆå€¼ (param2)</span><span class="slider-value" id="param2Value">14</span></div>
                            <input type="range" id="param2" min="8" max="25" value="14" step="1">
                            <div class="param-tip">âœ“ æ¨è14-16ï¼ˆè¶Šå°æ£€æµ‹è¶Šå¤šï¼‰</div>
                        </div>
                        <div class="slider-group">
                            <div class="slider-header"><span class="slider-label">åœ†å¿ƒæœ€å°è·ç¦»</span><span class="slider-value" id="minDistValue">10</span></div>
                            <input type="range" id="minDist" min="6" max="20" value="10" step="1">
                            <div class="param-tip">å¯†é›†å¹³æ¿ç”¨8-10</div>
                        </div>
                        <div class="slider-group">
                            <div class="slider-header"><span class="slider-label">æœ€å°åŠå¾„</span><span class="slider-value" id="minRadiusValue">3</span></div>
                            <input type="range" id="minRadius" min="2" max="8" value="3">
                        </div>
                        <div class="slider-group">
                            <div class="slider-header"><span class="slider-label">æœ€å¤§åŠå¾„</span><span class="slider-value" id="maxRadiusValue">25</span></div>
                            <input type="range" id="maxRadius" min="15" max="40" value="25">
                        </div>
                    </div>
                    
                    <div class="control-section">
                        <div class="section-title">ğŸ” äº®åº¦éªŒè¯æ¨¡å¼</div>
                        <div class="slider-group">
                            <div class="slider-header"><span class="slider-label">é˜ˆå€¼æ¨¡å¼</span></div>
                            <select id="thresholdMode">
                                <option value="adaptive" selected>è‡ªé€‚åº”ï¼ˆæ¨èï¼‰</option>
                                <option value="fixed">å›ºå®šé˜ˆå€¼</option>
                                <option value="relative">ç›¸å¯¹èƒŒæ™¯</option>
                            </select>
                        </div>
                        <div class="slider-group" id="fixedThresholdGroup" style="display: none;">
                            <div class="slider-header"><span class="slider-label">å›ºå®šäº®åº¦é˜ˆå€¼</span><span class="slider-value" id="fixedThresholdValue">170</span></div>
                            <input type="range" id="fixedThreshold" min="120" max="220" value="170">
                        </div>
                        <div class="slider-group" id="adaptiveOffsetGroup">
                            <div class="slider-header"><span class="slider-label">èƒŒæ™¯äº®åº¦åç§»</span><span class="slider-value" id="adaptiveOffsetValue">25</span></div>
                            <input type="range" id="adaptiveOffset" min="10" max="50" value="25">
                            <div class="param-tip">èŒè½æ¯”èƒŒæ™¯äº®å¤šå°‘</div>
                        </div>
                        <div class="slider-group">
                            <div class="slider-header"><span class="slider-label">è¾¹ç¼˜å¯¹æ¯”åº¦</span><span class="slider-value" id="edgeThresholdValue">10</span></div>
                            <input type="range" id="edgeThreshold" min="5" max="30" value="10">
                            <div class="param-tip">ä¸­å¿ƒæ¯”è¾¹ç¼˜äº®å¤šå°‘ï¼ˆåœ†çš„ç‰¹å¾ï¼‰</div>
                        </div>
                    </div>
                    
                    <div class="control-section">
                        <div class="section-title">ğŸ–¼ï¸ é¢„å¤„ç† / ROI</div>
                        <div class="slider-group">
                            <div class="slider-header"><span class="slider-label">å¯¹æ¯”åº¦å¢å¼º</span><span class="slider-value" id="contrastValue">1.5</span></div>
                            <input type="range" id="contrast" min="1.0" max="3.0" value="1.5" step="0.1">
                        </div>
                        <div class="slider-group">
                            <div class="slider-header"><span class="slider-label">é«˜æ–¯æ¨¡ç³Š</span><span class="slider-value" id="blurValue">5</span></div>
                            <input type="range" id="blurRadius" min="1" max="9" value="5" step="2">
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-warning btn-small" id="selectRoiBtn">ğŸ¯ é€‰æ‹©åŸ¹å…»çš¿</button>
                            <button class="btn btn-outline btn-small" id="clearRoiBtn">ğŸ—‘ï¸ æ¸…é™¤ROI</button>
                        </div>
                        <div class="mode-indicator" id="roiIndicator" style="display: none;"><span>â­•</span><span>ROIå·²è®¾å®š</span></div>
                    </div>
                    
                    <div class="control-section">
                        <div class="section-title">ğŸ§¹ åå¤„ç† / æ“ä½œ</div>
                        <div class="slider-group">
                            <div class="slider-header"><span class="slider-label">åˆå¹¶è·ç¦»</span><span class="slider-value" id="mergeDistValue">8</span></div>
                            <input type="range" id="mergeDist" min="4" max="20" value="8">
                        </div>
                        <div class="slider-group">
                            <div class="slider-header"><span class="slider-label">å›¾åƒç¼©æ”¾</span><span class="slider-value" id="zoomValue">1.00</span></div>
                            <input type="range" id="zoomSlider" min="0.05" max="3.0" value="1.0" step="0.05">
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-small" id="analyzeBtn">ğŸ”„ é‡æ–°åˆ†æ</button>
                            <button class="btn btn-success btn-small" id="addModeBtn">â• æ‰‹åŠ¨æ·»åŠ </button>
                            <button class="btn btn-info btn-small" id="toggleCirclesBtn">â­• æ˜¾éšåœ†åœˆ</button>
                            <button class="btn btn-outline btn-small" id="resetParamsBtn">â†º æ¢å¤é»˜è®¤</button>
                            <button class="btn btn-outline btn-small" id="exportImgBtn">ğŸ“¸ å¯¼å‡ºå›¾ç‰‡</button>
                            <button class="btn btn-danger btn-small" id="clearBtn">ğŸ—‘ï¸ æ¸…ç©º</button>
                            <button class="btn btn-outline btn-small" id="backBtn">â†©ï¸ æ–°å›¾ç‰‡</button>
                        </div>
                    </div>
                </div>
                
                <div class="image-wrapper" id="imageWrapper">
                    <div class="canvas-container" id="canvasContainer">
                        <canvas id="mainCanvas"></canvas>
                        <div class="overlay-layer" id="overlayLayer">
                            <div id="roiVisual" class="roi-marker"></div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-panel">
                    <div class="stat-box"><span class="stat-number" id="statTotal">0</span><div class="stat-label">æ€»èŒè½æ•°</div></div>
                    <div class="stat-box success"><span class="stat-number" id="statAuto">0</span><div class="stat-label">Houghæ£€æµ‹</div></div>
                    <div class="stat-box warning"><span class="stat-number" id="statManual">0</span><div class="stat-label">æ‰‹åŠ¨æ·»åŠ </div></div>
                    <div class="stat-box info"><span class="stat-number" id="statAvgRadius">0</span><div class="stat-label">å¹³å‡åŠå¾„(px)</div></div>
                </div>
            </div>
        </main>
    </div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">åˆ†æä¸­...</div>
        <div class="loading-subtext">è‡ªé€‚åº”é˜ˆå€¼ + å¤šç‰¹å¾éªŒè¯</div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        // å…¨å±€çŠ¶æ€
        let cvReady = false;
        let currentImage = null;
        let srcMat = null;
        let grayMat = null;
        let colonies = [];
        let isAddMode = false;
        let showCircles = true;
        let roiCenter = null;
        let roiRadius = null;
        let isRoiMode = false;
        let roiStart = null;
        
        const uploadCard = document.getElementById('uploadCard');
        const viewer = document.getElementById('viewer');
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const overlayLayer = document.getElementById('overlayLayer');
        const roiVisual = document.getElementById('roiVisual');
        const imageWrapper = document.getElementById('imageWrapper');
        
        const defaultParams = { param2: 14, minDist: 10, minRadius: 3, maxRadius: 25, contrast: 1.5, blurRadius: 5, mergeDist: 8, zoom: 1.0, adaptiveOffset: 25, edgeThreshold: 10, fixedThreshold: 170 };
        
        function onOpenCvReady() {
            cvReady = true;
            document.querySelector('.splash-subtitle').textContent = 'OpenCV åŠ è½½å®Œæˆ';
            setTimeout(() => document.getElementById('splash').classList.add('hidden'), 800);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('fileInput').addEventListener('change', handleFile);
            document.getElementById('cameraInput').addEventListener('change', handleFile);
            
            uploadCard.addEventListener('dragover', (e) => { e.preventDefault(); uploadCard.classList.add('active'); });
            uploadCard.addEventListener('dragleave', () => uploadCard.classList.remove('active'));
            uploadCard.addEventListener('drop', (e) => { e.preventDefault(); uploadCard.classList.remove('active'); if (e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]); });
            
            // æ»‘å—äº‹ä»¶
            ['param2', 'minDist', 'minRadius', 'maxRadius', 'contrast', 'blurRadius', 'mergeDist', 'adaptiveOffset', 'edgeThreshold', 'fixedThreshold'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    const displayId = id + 'Value';
                    const el = document.getElementById(displayId);
                    if (el) el.textContent = e.target.value;
                });
            });
            
            document.getElementById('zoomSlider').addEventListener('input', (e) => {
                document.getElementById('zoomValue').textContent = parseFloat(e.target.value).toFixed(2);
                applyZoom();
            });
            
            document.getElementById('thresholdMode').addEventListener('change', (e) => {
                document.getElementById('fixedThresholdGroup').style.display = e.target.value === 'fixed' ? 'block' : 'none';
                document.getElementById('adaptiveOffsetGroup').style.display = e.target.value === 'adaptive' ? 'block' : 'none';
            });
            
            // æŒ‰é’®
            document.getElementById('analyzeBtn').addEventListener('click', analyzeImage);
            document.getElementById('addModeBtn').addEventListener('click', toggleAddMode);
            document.getElementById('toggleCirclesBtn').addEventListener('click', toggleCircles);
            document.getElementById('clearBtn').addEventListener('click', clearAll);
            document.getElementById('backBtn').addEventListener('click', resetApp);
            document.getElementById('selectRoiBtn').addEventListener('click', enterRoiMode);
            document.getElementById('clearRoiBtn').addEventListener('click', clearRoi);
            document.getElementById('exportImgBtn').addEventListener('click', exportImage);
            document.getElementById('resetParamsBtn').addEventListener('click', resetToDefault);
            
            // Canvasäº‹ä»¶
            canvas.addEventListener('click', handleCanvasClick);
            canvas.addEventListener('mousedown', handleCanvasMouseDown);
            canvas.addEventListener('mousemove', handleCanvasMouseMove);
            canvas.addEventListener('mouseup', handleCanvasMouseUp);
            canvas.addEventListener('mouseleave', cancelRoiDraw);
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd);
            canvas.addEventListener('touchcancel', cancelRoiDraw);
        });
        
        function handleFile(e) { if (e.target.files.length) processFile(e.target.files[0]); }
        
        function processFile(file) {
            if (!file.type.startsWith('image/')) { showToast('âŒ è¯·é€‰æ‹©å›¾ç‰‡'); return; }
            const reader = new FileReader();
            reader.onload = (e) => { const img = new Image(); img.onload = () => { currentImage = img; initOpenCV(img); }; img.src = e.target.result; };
            reader.readAsDataURL(file);
        }
        
        function initOpenCV(img) {
            if (!cvReady) { showToast('â³ OpenCVåŠ è½½ä¸­...'); setTimeout(() => initOpenCV(img), 1000); return; }
            if (srcMat) srcMat.delete();
            if (grayMat) grayMat.delete();
            srcMat = cv.imread(img);
            grayMat = new cv.Mat();
            cv.cvtColor(srcMat, grayMat, cv.COLOR_RGBA2GRAY);
            displayImage(img);
            analyzeImage();
            uploadCard.style.display = 'none';
            viewer.classList.add('active');
        }
        
        function displayImage(img) {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            canvas.dataset.origWidth = img.width;
            canvas.dataset.origHeight = img.height;
            
            const containerWidth = imageWrapper.clientWidth;
            let fitScale = containerWidth / img.width;
            fitScale = Math.min(3.0, Math.max(0.05, fitScale));
            document.getElementById('zoomSlider').value = fitScale.toFixed(2);
            document.getElementById('zoomValue').textContent = fitScale.toFixed(2);
            applyZoom();
        }
        
        function applyZoom() {
            const zoom = parseFloat(document.getElementById('zoomSlider').value);
            canvas.style.width = (canvas.width * zoom) + 'px';
            canvas.style.height = (canvas.height * zoom) + 'px';
            renderMarkers();
        }
        
        function resetToDefault() {
            Object.keys(defaultParams).forEach(key => {
                const el = document.getElementById(key === 'zoom' ? 'zoomSlider' : key === 'adaptiveOffset' ? 'adaptiveOffset' : key === 'edgeThreshold' ? 'edgeThreshold' : key === 'fixedThreshold' ? 'fixedThreshold' : key);
                if (el) {
                    el.value = defaultParams[key];
                    const displayId = key + 'Value';
                    const displayEl = document.getElementById(displayId);
                    if (displayEl) displayEl.textContent = typeof defaultParams[key] === 'number' && defaultParams[key] < 10 ? defaultParams[key].toFixed(2) : defaultParams[key];
                }
            });
            if (currentImage) {
                const containerWidth = imageWrapper.clientWidth;
                let fitScale = containerWidth / currentImage.width;
                fitScale = Math.min(3.0, Math.max(0.05, fitScale));
                document.getElementById('zoomSlider').value = fitScale.toFixed(2);
                document.getElementById('zoomValue').textContent = fitScale.toFixed(2);
                applyZoom();
            }
            analyzeImage();
        }
        
        // ROIåŠŸèƒ½
        function enterRoiMode() { if (!currentImage) return; isRoiMode = true; canvas.style.cursor = 'crosshair'; showToast('æŒ‰ä¸‹/è§¦æ‘¸ç¡®å®šåœ†å¿ƒï¼Œæ‹–åŠ¨è®¾å®šåŠå¾„'); }
        function clearRoi() { roiCenter = null; roiRadius = null; roiVisual.style.display = 'none'; document.getElementById('roiIndicator').style.display = 'none'; showToast('ROIå·²æ¸…é™¤'); }
        
        function updateRoiVisual() {
            if (!roiCenter || !roiRadius) { roiVisual.style.display = 'none'; return; }
            const zoom = parseFloat(document.getElementById('zoomSlider').value);
            roiVisual.style.left = ((roiCenter.x - roiRadius) * zoom) + 'px';
            roiVisual.style.top = ((roiCenter.y - roiRadius) * zoom) + 'px';
            roiVisual.style.width = (roiRadius * 2 * zoom) + 'px';
            roiVisual.style.height = (roiRadius * 2 * zoom) + 'px';
            roiVisual.style.display = 'block';
            document.getElementById('roiIndicator').style.display = 'inline-flex';
        }
        
        function getImageCoordsFromEvent(e) {
            const rect = canvas.getBoundingClientRect();
            const zoom = parseFloat(document.getElementById('zoomSlider').value);
            let clientX, clientY;
            if (e.touches) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; e.preventDefault(); }
            else { clientX = e.clientX; clientY = e.clientY; }
            return { x: (clientX - rect.left) / zoom, y: (clientY - rect.top) / zoom };
        }
        
        function handleCanvasMouseDown(e) { if (!isRoiMode) return; const { x, y } = getImageCoordsFromEvent(e); roiStart = { x, y }; roiVisual.style.display = 'block'; }
        function handleCanvasMouseMove(e) { if (!isRoiMode || !roiStart) return; e.preventDefault(); const { x, y } = getImageCoordsFromEvent(e); const radius = Math.sqrt((x - roiStart.x)**2 + (y - roiStart.y)**2); const zoom = parseFloat(document.getElementById('zoomSlider').value); roiVisual.style.left = ((roiStart.x - radius) * zoom) + 'px'; roiVisual.style.top = ((roiStart.y - radius) * zoom) + 'px'; roiVisual.style.width = (radius * 2 * zoom) + 'px'; roiVisual.style.height = (radius * 2 * zoom) + 'px'; }
        function handleCanvasMouseUp(e) { if (!isRoiMode || !roiStart) return; const { x, y } = getImageCoordsFromEvent(e); const radius = Math.sqrt((x - roiStart.x)**2 + (y - roiStart.y)**2); if (radius > 2) { roiCenter = { x: roiStart.x, y: roiStart.y }; roiRadius = radius; updateRoiVisual(); showToast(`ROIå·²è®¾ç½®: åŠå¾„${Math.round(radius)}px`); } else { clearRoi(); } isRoiMode = false; roiStart = null; canvas.style.cursor = 'default'; }
        function handleTouchStart(e) { e.preventDefault(); if (!isRoiMode) return; const { x, y } = getImageCoordsFromEvent(e); roiStart = { x, y }; roiVisual.style.display = 'block'; }
        function handleTouchMove(e) { e.preventDefault(); if (!isRoiMode || !roiStart) return; const { x, y } = getImageCoordsFromEvent(e); const radius = Math.sqrt((x - roiStart.x)**2 + (y - roiStart.y)**2); const zoom = parseFloat(document.getElementById('zoomSlider').value); roiVisual.style.left = ((roiStart.x - radius) * zoom) + 'px'; roiVisual.style.top = ((roiStart.y - radius) * zoom) + 'px'; roiVisual.style.width = (radius * 2 * zoom) + 'px'; roiVisual.style.height = (radius * 2 * zoom) + 'px'; }
        function handleTouchEnd(e) { e.preventDefault(); if (!isRoiMode || !roiStart) return; const touch = e.changedTouches[0]; const rect = canvas.getBoundingClientRect(); const zoom = parseFloat(document.getElementById('zoomSlider').value); const x = (touch.clientX - rect.left) / zoom; const y = (touch.clientY - rect.top) / zoom; const radius = Math.sqrt((x - roiStart.x)**2 + (y - roiStart.y)**2); if (radius > 2) { roiCenter = { x: roiStart.x, y: roiStart.y }; roiRadius = radius; updateRoiVisual(); showToast(`ROIå·²è®¾ç½®: åŠå¾„${Math.round(radius)}px`); } else { clearRoi(); } isRoiMode = false; roiStart = null; canvas.style.cursor = 'default'; }
        function cancelRoiDraw() { if (isRoiMode) { isRoiMode = false; roiStart = null; canvas.style.cursor = 'default'; roiVisual.style.display = roiCenter ? 'block' : 'none'; } }
        
        // ========== æ ¸å¿ƒæ”¹è¿›ï¼šanalyzeImage ==========
        function analyzeImage() {
            if (!grayMat || !cvReady) return;
            document.getElementById('loadingOverlay').classList.add('active');
            
            setTimeout(() => {
                try {
                    const param2 = parseInt(document.getElementById('param2').value);
                    const minDist = parseInt(document.getElementById('minDist').value);
                    const minRadius = parseInt(document.getElementById('minRadius').value);
                    const maxRadius = parseInt(document.getElementById('maxRadius').value);
                    const contrast = parseFloat(document.getElementById('contrast').value);
                    const blurRadius = parseInt(document.getElementById('blurRadius').value);
                    const mergeDist = parseInt(document.getElementById('mergeDist').value);
                    const thresholdMode = document.getElementById('thresholdMode').value;
                    const adaptiveOffset = parseInt(document.getElementById('adaptiveOffset').value);
                    const edgeThreshold = parseInt(document.getElementById('edgeThreshold').value);
                    const fixedThreshold = parseInt(document.getElementById('fixedThreshold').value);
                    
                    // 1. å¯¹æ¯”åº¦å¢å¼º
                    let procMat = new cv.Mat();
                    grayMat.convertTo(procMat, -1, contrast, 0);
                    
                    // 2. CLAHEè‡ªé€‚åº”ç›´æ–¹å›¾å‡è¡¡
                    let clahe = new cv.CLAHE(2.0, new cv.Size(8, 8));
                    let enhanced = new cv.Mat();
                    clahe.apply(procMat, enhanced);
                    
                    // 3. é«˜æ–¯æ¨¡ç³Š
                    let blurred = new cv.Mat();
                    let ksize = blurRadius % 2 === 0 ? blurRadius + 1 : blurRadius;
                    cv.GaussianBlur(enhanced, blurred, new cv.Size(ksize, ksize), 0);
                    
                    // 4. Houghåœ†æ£€æµ‹ï¼ˆå…³é”®æ”¹è¿›ï¼šå¯è°ƒminDistï¼‰
                    let circles = new cv.Mat();
                    cv.HoughCircles(blurred, circles, cv.HOUGH_GRADIENT, 1, minDist, 40, param2, minRadius, maxRadius);
                    
                    // 5. è®¡ç®—èƒŒæ™¯äº®åº¦ï¼ˆç”¨äºè‡ªé€‚åº”é˜ˆå€¼ï¼‰
                    let bgBrightness = 128;
                    if (thresholdMode === 'adaptive') {
                        let bgMean = cv.mean(enhanced);
                        bgBrightness = bgMean[0];
                    }
                    
                    // 6. å¤šç‰¹å¾éªŒè¯
                    let detected = [];
                    if (circles.cols > 0) {
                        for (let i = 0; i < circles.cols; i++) {
                            const x = circles.data32F[i * 3];
                            const y = circles.data32F[i * 3 + 1];
                            const radius = circles.data32F[i * 3 + 2];
                            
                            // é‡‡æ ·ä¸­å¿ƒäº®åº¦
                            const sampleR = Math.max(2, Math.floor(radius * 0.3));
                            const x1 = Math.max(0, Math.floor(x - sampleR));
                            const y1 = Math.max(0, Math.floor(y - sampleR));
                            const x2 = Math.min(enhanced.cols, Math.floor(x + sampleR));
                            const y2 = Math.min(enhanced.rows, Math.floor(y + sampleR));
                            if (x2 <= x1 || y2 <= y1) continue;
                            
                            let centerRoi = enhanced.roi(new cv.Rect(x1, y1, x2 - x1, y2 - y1));
                            let centerMean = cv.mean(centerRoi);
                            centerRoi.delete();
                            const centerBrightness = centerMean[0];
                            
                            // é‡‡æ ·è¾¹ç¼˜äº®åº¦ï¼ˆéªŒè¯åœ†å½¢ç‰¹å¾ï¼‰
                            let edgeBrightness = 0, edgeSamples = 0;
                            for (let angle = 0; angle < Math.PI * 2; angle += Math.PI / 4) {
                                const ex = Math.floor(x + Math.cos(angle) * radius * 0.8);
                                const ey = Math.floor(y + Math.sin(angle) * radius * 0.8);
                                if (ex > 0 && ex < enhanced.cols && ey > 0 && ey < enhanced.rows) {
                                    edgeBrightness += enhanced.ucharAt(ey, ex);
                                    edgeSamples++;
                                }
                            }
                            edgeBrightness = edgeSamples > 0 ? edgeBrightness / edgeSamples : 0;
                            
                            // äº®åº¦é˜ˆå€¼åˆ¤æ–­
                            let isValid = false;
                            if (thresholdMode === 'adaptive') {
                                isValid = centerBrightness > bgBrightness + adaptiveOffset && centerBrightness > edgeBrightness + edgeThreshold;
                            } else if (thresholdMode === 'fixed') {
                                isValid = centerBrightness > fixedThreshold && centerBrightness > edgeBrightness + edgeThreshold;
                            } else { // relative
                                isValid = centerBrightness > edgeBrightness + edgeThreshold;
                            }
                            
                            if (isValid) {
                                detected.push({
                                    id: i, x: x, y: y, radius: radius,
                                    brightness: centerBrightness,
                                    confidence: (centerBrightness - edgeBrightness) / 255,
                                    manual: false
                                });
                            }
                        }
                    }
                    
                    // 7. ROIè¿‡æ»¤
                    if (roiCenter && roiRadius) {
                        detected = detected.filter(c => {
                            const dx = c.x - roiCenter.x, dy = c.y - roiCenter.y;
                            return (dx*dx + dy*dy) <= (roiRadius * roiRadius);
                        });
                    }
                    
                    // 8. NMSåˆå¹¶
                    detected = nonMaxSuppression(detected, mergeDist);
                    
                    colonies = detected;
                    
                    // æ¸…ç†
                    procMat.delete(); enhanced.delete(); clahe.delete(); blurred.delete(); circles.delete();
                    
                    renderMarkers();
                    updateStats();
                    showToast(`âœ… æ£€æµ‹åˆ° ${colonies.length} ä¸ªèŒè½`);
                    
                } catch (err) {
                    console.error(err);
                    showToast('âŒ åˆ†æå¤±è´¥: ' + err.message);
                }
                document.getElementById('loadingOverlay').classList.remove('active');
            }, 100);
        }
        
        function nonMaxSuppression(circles, minDist) {
            if (circles.length < 2) return circles;
            circles.sort((a, b) => b.confidence - a.confidence);
            let result = [], suppressed = new Array(circles.length).fill(false);
            for (let i = 0; i < circles.length; i++) {
                if (suppressed[i]) continue;
                result.push(circles[i]);
                for (let j = i + 1; j < circles.length; j++) {
                    if (suppressed[j]) continue;
                    const dx = circles[i].x - circles[j].x, dy = circles[i].y - circles[j].y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < minDist || dist < (circles[i].radius + circles[j].radius) * 0.5) suppressed[j] = true;
                }
            }
            return result;
        }
        
        function renderMarkers() {
            overlayLayer.innerHTML = ''; overlayLayer.appendChild(roiVisual);
            const zoom = parseFloat(document.getElementById('zoomSlider').value);
            colonies.forEach((colony, idx) => {
                const marker = document.createElement('div');
                marker.className = `colony-marker ${colony.manual ? 'manual' : ''}`;
                marker.style.left = (colony.x * zoom) + 'px';
                marker.style.top = (colony.y * zoom) + 'px';
                if (showCircles) {
                    const circle = document.createElement('div');
                    circle.className = 'marker-circle';
                    circle.style.width = (colony.radius * zoom * 2) + 'px';
                    circle.style.height = (colony.radius * zoom * 2) + 'px';
                    marker.appendChild(circle);
                }
                const center = document.createElement('div'); center.className = 'marker-center'; marker.appendChild(center);
                const tooltip = document.createElement('div'); tooltip.className = 'marker-tooltip'; tooltip.textContent = `#${idx + 1} | r=${Math.round(colony.radius)}`; marker.appendChild(tooltip);
                marker.onclick = (e) => { e.stopPropagation(); removeColony(idx); };
                overlayLayer.appendChild(marker);
            });
            if (roiCenter && roiRadius) updateRoiVisual();
        }
        
        function updateStats() {
            const auto = colonies.filter(c => !c.manual).length, manual = colonies.filter(c => c.manual).length;
            const avgRadius = colonies.length > 0 ? (colonies.reduce((sum, c) => sum + c.radius, 0) / colonies.length).toFixed(1) : 0;
            document.getElementById('statTotal').textContent = colonies.length;
            document.getElementById('statAuto').textContent = auto;
            document.getElementById('statManual').textContent = manual;
            document.getElementById('statAvgRadius').textContent = avgRadius;
        }
        
        function removeColony(index) { colonies.splice(index, 1); colonies.forEach((c, idx) => c.id = idx); renderMarkers(); updateStats(); showToast('ğŸ—‘ï¸ å·²åˆ é™¤'); }
        
        function toggleAddMode() {
            isAddMode = !isAddMode;
            const btn = document.getElementById('addModeBtn');
            if (isAddMode) { btn.style.background = 'var(--success)'; btn.innerHTML = '<span>âœ“</span><span>å®Œæˆæ·»åŠ </span>'; canvas.style.cursor = 'crosshair'; }
            else { btn.style.background = ''; btn.innerHTML = '<span>â•</span><span>æ‰‹åŠ¨æ·»åŠ </span>'; canvas.style.cursor = 'default'; }
        }
        
        function toggleCircles() { showCircles = !showCircles; renderMarkers(); showToast(showCircles ? 'â­• æ˜¾ç¤ºåœ†åœˆ' : 'â­• éšè—åœ†åœˆ'); }
        
        function handleCanvasClick(e) {
            if (!isAddMode) return;
            const { x, y } = getImageCoordsFromEvent(e);
            const avgRadius = colonies.length > 0 ? colonies.reduce((sum, c) => sum + c.radius, 0) / colonies.length : 10;
            colonies.push({ id: colonies.length, x: x, y: y, radius: avgRadius, brightness: 255, manual: true });
            renderMarkers(); updateStats(); showToast('âœ… å·²æ·»åŠ ');
        }
        
        function clearAll() { if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ ‡è®°ï¼Ÿ')) { colonies = []; renderMarkers(); updateStats(); showToast('ğŸ—‘ï¸ å·²æ¸…ç©º'); } }
        
        function resetApp() {
            if (srcMat) { srcMat.delete(); srcMat = null; }
            if (grayMat) { grayMat.delete(); grayMat = null; }
            currentImage = null; colonies = []; isAddMode = false; clearRoi();
            uploadCard.style.display = 'block'; viewer.classList.remove('active');
            overlayLayer.innerHTML = ''; overlayLayer.appendChild(roiVisual);
            canvas.style.cursor = 'default';
        }
        
        function exportImage() {
            if (!currentImage) return;
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = currentImage.width; exportCanvas.height = currentImage.height;
            const eCtx = exportCanvas.getContext('2d');
            eCtx.drawImage(currentImage, 0, 0);
            colonies.forEach(c => {
                eCtx.beginPath(); eCtx.arc(c.x, c.y, c.radius, 0, 2 * Math.PI);
                eCtx.strokeStyle = c.manual ? 'gold' : '#ff4757'; eCtx.lineWidth = 2; eCtx.stroke();
                eCtx.beginPath(); eCtx.arc(c.x, c.y, 3, 0, 2 * Math.PI);
                eCtx.fillStyle = c.manual ? 'gold' : '#00ff88'; eCtx.fill();
            });
            const link = document.createElement('a'); link.download = `colonies_${Date.now()}.png`; link.href = exportCanvas.toDataURL('image/png'); link.click();
            showToast('ğŸ“¸ å›¾ç‰‡å·²å¯¼å‡º');
        }
        
        function showToast(msg) { const toast = document.getElementById('toast'); toast.textContent = msg; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 3000); }
        
        window.addEventListener('resize', () => { if (currentImage && viewer.classList.contains('active')) { const containerWidth = imageWrapper.clientWidth; let fitScale = containerWidth / currentImage.width; fitScale = Math.min(3.0, Math.max(0.05, fitScale)); document.getElementById('zoomSlider').value = fitScale.toFixed(2); document.getElementById('zoomValue').textContent = fitScale.toFixed(2); applyZoom(); } });
        
        if ('serviceWorker' in navigator) { const swCode = `self.addEventListener('install',e=>self.skipWaiting()); self.addEventListener('activate',e=>e.waitUntil(clients.claim())); self.addEventListener('fetch',e=>e.respondWith(fetch(e.request)));`; const blob = new Blob([swCode], { type: 'application/javascript' }); navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(()=>{}); }
    </script>
</body>
</html>
