<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èŒè½è®¡æ•°å™¨ Pro (ä¼˜åŒ–ç‰ˆ) - Colony Counter Pro</title>
    <script src="https://docs.opencv.org/4.8.0/opencv.js" async></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .canvas-container { position: relative; display: inline-block; }
        #resultCanvas { max-width: 100%; height: auto; }
        .loading { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .param-slider { -webkit-appearance: none; appearance: none; height: 6px; background: #e5e7eb; border-radius: 5px; outline: none; }
        .param-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #3b82f6; border-radius: 50%; cursor: pointer; }
        .blink { animation: blink 1.5s ease-in-out infinite alternate; }
        @keyframes blink { from { opacity: 1; } to { opacity: 0.6; } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="flex items-center justify-between max-w-6xl mx-auto">
            <div class="flex items-center gap-3">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                <div>
                    <h1 class="text-xl font-bold">èŒè½è®¡æ•°å™¨ Pro</h1>
                    <p class="text-xs opacity-80">åŠ¨æ€å¹³æ¿æ£€æµ‹ | é»è¿åˆ†å‰² | è¾¹ç¼˜ä¼˜åŒ–</p>
                </div>
            </div>
            <span class="text-xs bg-white text-blue-600 px-3 py-1 rounded-full font-semibold blink">AI ä¼˜åŒ–ç‰ˆ</span>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 space-y-6">
        <!-- ä¸Šä¼ åŒº -->
        <div class="bg-white rounded-2xl shadow-xl p-6 text-center" id="uploadSection">
            <div class="border-4 border-dashed border-gray-300 rounded-xl p-10 hover:border-blue-400 transition-all duration-300 cursor-pointer transform hover:scale-[1.01]" onclick="document.getElementById('fileInput').click()" id="dropZone">
                <div class="w-24 h-24 mx-auto mb-6 relative">
                    <div class="absolute inset-0 bg-blue-100 rounded-full animate-ping opacity-20"></div>
                    <svg class="w-24 h-24 relative text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <p class="text-2xl font-bold text-gray-800 mb-3">ä¸Šä¼ åŸ¹å…»çš¿å›¾åƒ</p>
                <p class="text-gray-500 max-w-md mx-auto">æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œå»ºè®®æ‹æ‘„æ—¶å…‰çº¿å‡åŒ€ï¼ŒåŸ¹å…»çš¿è¾¹ç¼˜æ¸…æ™°å¯è§ã€‚ç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«å¹³æ¿åŒºåŸŸå¹¶ä¼˜åŒ–è¾¹ç¼˜è®¡æ•°ã€‚</p>
            </div>
            <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleImage(event)">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8">
                <button onclick="openCamera()" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-xl font-semibold hover:shadow-lg transition-all flex items-center justify-center gap-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    æ‰“å¼€ç›¸æœºæ‹ç…§
                </button>
                <button onclick="loadSample()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white py-4 rounded-xl font-semibold hover:shadow-lg transition-all flex items-center justify-center gap-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                    åŠ è½½ç¤ºä¾‹å›¾åƒ
                </button>
            </div>
            <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden" onchange="handleImage(event)">
            
            <div class="mt-6 text-sm text-gray-400">
                <p class="inline-flex items-center gap-1"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg> ä¼˜åŒ–åŠŸèƒ½å·²å¯ç”¨ï¼šåŠ¨æ€å¹³æ¿è¯†åˆ« + é»è¿èŒè½åˆ†å‰²</p>
            </div>
        </div>

        <!-- å¤„ç†çŠ¶æ€ -->
        <div id="processingStatus" class="hidden bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-2xl p-8 text-center">
            <div class="flex flex-col items-center">
                <div class="relative mb-6">
                    <div class="loading absolute inset-0 border-4 border-blue-600 border-t-transparent rounded-full"></div>
                    <div class="w-20 h-20 border-4 border-blue-200 rounded-full flex items-center justify-center">
                        <span id="progressText" class="text-2xl font-bold text-blue-700">0%</span>
                    </div>
                </div>
                <p class="text-xl font-semibold text-blue-900 mb-2">æ­£åœ¨æ™ºèƒ½åˆ†æèŒè½...</p>
                <p class="text-blue-700" id="processStep">åˆå§‹åŒ– OpenCV å¼•æ“...</p>
                <div class="w-full max-w-md bg-blue-100 rounded-full h-2.5 mt-6 overflow-hidden">
                    <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="grid grid-cols-4 gap-2 text-xs text-blue-600 mt-4 w-full max-w-md">
                    <span>ğŸ“· å›¾åƒåŠ è½½</span>
                    <span>ğŸ” å¹³æ¿æ£€æµ‹</span>
                    <span>ğŸ§© é»è¿åˆ†å‰²</span>
                    <span>âœ… éªŒè¯è®¡æ•°</span>
                </div>
            </div>
        </div>

        <!-- ç»“æœå±•ç¤ºåŒº -->
        <div id="resultsSection" class="hidden space-y-6">
            <!-- æ ¸å¿ƒè®¡æ•° -->
            <div class="bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 rounded-2xl shadow-2xl p-8 text-white text-center transform transition-transform hover:scale-[1.01]">
                <p class="text-blue-100 text-sm uppercase tracking-widest mb-2 font-medium">æ£€æµ‹åˆ°çš„èŒè½æ€»æ•°</p>
                <p class="text-7xl font-extrabold mb-2" id="colonyCount">0</p>
                <div class="flex justify-center items-center gap-6 text-sm">
                    <span class="bg-white/20 px-3 py-1 rounded-full">CFU</span>
                    <span class="bg-white/20 px-3 py-1 rounded-full" id="countTime">åˆ†ææ—¶é—´: 0.0s</span>
                    <span class="bg-white/20 px-3 py-1 rounded-full" id="plateInfo">å¹³æ¿: è‡ªåŠ¨è¯†åˆ«</span>
                </div>
            </div>

            <!-- å›¾åƒä¸ç»Ÿè®¡ -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- æ£€æµ‹ç»“æœå›¾ -->
                <div class="lg:col-span-2 bg-white rounded-2xl shadow-xl p-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">èŒè½æ£€æµ‹å¯è§†åŒ–</h3>
                            <p class="text-gray-500 text-sm">è“è‰²åœ†åœˆï¼šå•ä¸ªèŒè½ | ç»¿è‰²åœ†ç‚¹ï¼šèŒè½ä¸­å¿ƒ | çº¢è‰²è™šçº¿ï¼šåŸ¹å…»çš¿è¾¹ç•Œ</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="toggleOverlay()" id="toggleOverlayBtn" class="bg-blue-100 text-blue-700 hover:bg-blue-200 px-4 py-2 rounded-lg transition flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                æ˜¾ç¤ºåŸå›¾
                            </button>
                            <button onclick="downloadResult()" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:shadow-lg px-4 py-2 rounded-lg transition flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                ä¿å­˜ç»“æœ
                            </button>
                        </div>
                    </div>
                    <div class="canvas-container w-full border border-gray-200 rounded-xl overflow-hidden bg-gray-50">
                        <canvas id="resultCanvas"></canvas>
                    </div>
                    <div class="flex justify-center gap-6 mt-4 text-sm text-gray-600">
                        <span class="flex items-center gap-2"><div class="w-3 h-3 border-2 border-blue-500 rounded-full"></div> èŒè½è½®å»“</span>
                        <span class="flex items-center gap-2"><div class="w-2 h-2 bg-green-500 rounded-full"></div> èŒè½ä¸­å¿ƒ</span>
                        <span class="flex items-center gap-2"><div class="w-3 h-3 border border-red-400 border-dashed rounded-full"></div> å¹³æ¿è¾¹ç•Œ</span>
                    </div>
                </div>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="space-y-6">
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                            ç»Ÿè®¡ä¿¡æ¯
                        </h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-4 bg-gradient-to-r from-gray-50 to-white rounded-xl border border-gray-100">
                                <div>
                                    <p class="text-sm text-gray-500">èŒè½å¯†åº¦</p>
                                    <p class="text-2xl font-bold text-gray-800" id="densityValue">0 /cmÂ²</p>
                                </div>
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-4 rounded-xl">
                                    <p class="text-sm text-gray-500">å¹³å‡åŠå¾„</p>
                                    <p class="text-xl font-semibold text-gray-800" id="avgRadius">0 px</p>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-xl">
                                    <p class="text-sm text-gray-500">å¹³æ¿é¢ç§¯</p>
                                    <p class="text-xl font-semibold text-gray-800" id="plateArea">0 %</p>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-xl">
                                    <p class="text-sm text-gray-500">æœ€å°èŒè½</p>
                                    <p class="text-xl font-semibold text-gray-800" id="minRadius">0 px</p>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-xl">
                                    <p class="text-sm text-gray-500">æœ€å¤§èŒè½</p>
                                    <p class="text-xl font-semibold text-gray-800" id="maxRadius">0 px</p>
                                </div>
                            </div>
                            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-100 p-4 rounded-xl">
                                <p class="text-sm text-green-800 font-medium">è¾¹ç¼˜èŒè½ä¼˜åŒ–</p>
                                <p class="text-xs text-green-600 mt-1" id="edgeCountInfo">å·²å¯¹ 0 ä¸ªè¾¹ç¼˜èŒè½åº”ç”¨å®½å®¹åº¦æ£€æµ‹</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é«˜çº§å‚æ•° -->
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        é«˜çº§å‚æ•°è°ƒæ•´
                    </h3>
                    <button onclick="resetParams()" class="text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        é‡ç½®é»˜è®¤
                    </button>
                </div>
                
                <div class="space-y-6">
                    <!-- åŸºæœ¬å‚æ•° -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-4 text-sm uppercase tracking-wider">åŸºæœ¬æ£€æµ‹å‚æ•°</h4>
                        <div class="space-y-5">
                            <div>
                                <div class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                                    <span>æœ€å°èŒè½åŠå¾„</span>
                                    <span id="minSigmaVal" class="text-blue-600 font-bold">2.5 åƒç´ </span>
                                </div>
                                <input type="range" id="minSigma" min="1" max="10" step="0.5" value="2.5" class="param-slider w-full" oninput="updateParam('minSigma', this.value)">
                            </div>
                            
                            <div>
                                <div class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                                    <span>æœ€å¤§èŒè½åŠå¾„</span>
                                    <span id="maxSigmaVal" class="text-blue-600 font-bold">15 åƒç´ </span>
                                </div>
                                <input type="range" id="maxSigma" min="5" max="30" step="1" value="15" class="param-slider w-full" oninput="updateParam('maxSigma', this.value)">
                            </div>
                            
                            <div>
                                <div class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                                    <span>æ£€æµ‹çµæ•åº¦</span>
                                    <span id="thresholdVal" class="text-blue-600 font-bold">0.04</span>
                                </div>
                                <input type="range" id="threshold" min="0.01" max="0.2" step="0.01" value="0.04" class="param-slider w-full" oninput="updateParam('threshold', this.value)">
                            </div>
                        </div>
                    </div>
                    
                    <!-- é«˜çº§ç®—æ³•å‚æ•° -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-4 text-sm uppercase tracking-wider">é«˜çº§ç®—æ³•å‚æ•°</h4>
                        <div class="space-y-5">
                            <div>
                                <div class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                                    <span>é»è¿åˆ†å‰²å¼ºåº¦</span>
                                    <span id="watershedVal" class="text-purple-600 font-bold">ä¸­</span>
                                </div>
                                <input type="range" id="watershedLevel" min="1" max="3" step="1" value="2" class="param-slider w-full" oninput="updateParam('watershedLevel', this.value)">
                            </div>
                            
                            <div>
                                <div class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                                    <span>è¾¹ç¼˜å®½å®¹åº¦</span>
                                    <span id="edgeToleranceVal" class="text-purple-600 font-bold">70%</span>
                                </div>
                                <input type="range" id="edgeTolerance" min="20" max="100" step="5" value="70" class="param-slider w-full" oninput="updateParam('edgeTolerance', this.value)">
                            </div>
                            
                            <div>
                                <div class="flex justify-between text-sm font-medium text-gray-700 mb-2">
                                    <span>NMSè·ç¦»é˜ˆå€¼</span>
                                    <span id="nmsVal" class="text-purple-600 font-bold">12 åƒç´ </span>
                                </div>
                                <input type="range" id="nmsDist" min="5" max="30" step="1" value="12" class="param-slider w-full" oninput="updateParam('nmsDist', this.value)">
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 pt-4">
                        <button onclick="reprocess()" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 rounded-xl font-semibold hover:shadow-lg transition flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            é‡æ–°åˆ†æ
                        </button>
                        <button onclick="exportData()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white py-3 rounded-xl font-semibold hover:shadow-lg transition flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            å¯¼å‡ºæ•°æ®
                        </button>
                    </div>
                </div>
            </div>

            <!-- åˆ†ææ–°å›¾ç‰‡ -->
            <button onclick="resetAll()" class="w-full bg-gradient-to-r from-gray-100 to-gray-200 text-gray-800 py-4 rounded-xl font-semibold hover:shadow-lg transition flex items-center justify-center gap-3">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                åˆ†ææ–°å›¾åƒ
            </button>
        </div>

        <!-- è¯´æ˜å¡ç‰‡ -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-2xl p-6">
            <h4 class="font-bold text-blue-900 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                ä¼˜åŒ–åŠŸèƒ½è¯´æ˜
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded-xl">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mb-3">
                        <span class="text-blue-600 font-bold">1</span>
                    </div>
                    <h5 class="font-semibold text-blue-900 mb-2">åŠ¨æ€å¹³æ¿æ£€æµ‹</h5>
                    <p class="text-sm text-blue-700">è‡ªåŠ¨è¯†åˆ«åŸ¹å…»çš¿ä½ç½®å’Œå¤§å°ï¼Œæ— éœ€æ‰‹åŠ¨æ¡†é€‰ï¼Œé€‚åº”ä¸åŒæ‹æ‘„è§’åº¦å’Œå…‰ç…§æ¡ä»¶ã€‚</p>
                </div>
                <div class="bg-white p-4 rounded-xl">
                    <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mb-3">
                        <span class="text-purple-600 font-bold">2</span>
                    </div>
                    <h5 class="font-semibold text-purple-900 mb-2">é»è¿èŒè½åˆ†å‰²</h5>
                    <p class="text-sm text-purple-700">åº”ç”¨åˆ†æ°´å²­ç®—æ³•ï¼Œè‡ªåŠ¨åˆ†ç¦»ç›¸äº’æ¥è§¦çš„èŒè½ï¼Œæé«˜è®¡æ•°å‡†ç¡®æ€§ã€‚</p>
                </div>
                <div class="bg-white p-4 rounded-xl">
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mb-3">
                        <span class="text-green-600 font-bold">3</span>
                    </div>
                    <h5 class="font-semibold text-green-900 mb-2">è¾¹ç¼˜æŠ˜å°„ä¼˜åŒ–</h5>
                    <p class="text-sm text-green-700">é’ˆå¯¹å¹³æ¿è¾¹ç¼˜çš„æŠ˜å°„æ•ˆåº”ï¼Œè‡ªåŠ¨åº”ç”¨å®½å®¹åº¦æ£€æµ‹ï¼Œå‡å°‘æ¼æ£€å’Œè¯¯æ£€ã€‚</p>
                </div>
            </div>
            <div class="mt-6 text-sm text-blue-700 bg-white/50 p-4 rounded-xl">
                <p class="font-medium mb-2">ä½¿ç”¨æç¤ºï¼š</p>
                <ul class="list-disc list-inside space-y-1">
                    <li>é¦–æ¬¡åŠ è½½éœ€è¦10-20ç§’åˆå§‹åŒ–OpenCV.jsåº“ï¼ˆçº¦80MBï¼‰</li>
                    <li>å¯¹äºé»è¿ä¸¥é‡çš„å›¾åƒï¼Œå¯é€‚å½“æé«˜"é»è¿åˆ†å‰²å¼ºåº¦"å‚æ•°</li>
                    <li>è¾¹ç¼˜å®½å®¹åº¦å‚æ•°å¯å¹³è¡¡è¾¹ç¼˜èŒè½çš„æ£€æµ‹çµæ•åº¦å’Œè¯¯æ£€ç‡</li>
                    <li>åˆ†æå®Œæˆåå¯å¯¼å‡ºåŒ…å«èŒè½ä½ç½®ä¿¡æ¯çš„CSVæ–‡ä»¶</li>
                </ul>
            </div>
        </div>
    </main>

    <script>
        // å…¨å±€å˜é‡
        let cvReady = false;
        let currentImage = null;
        let currentResult = null;
        let processingStartTime = 0;
        let showOriginal = false;
        let detectedPlate = { centerX: 0, centerY: 0, radius: 0 };
        
        // å‚æ•°é…ç½®
        let params = {
            minSigma: 2.5,
            maxSigma: 15,
            threshold: 0.04,
            nmsDist: 12,
            intensity: 120,
            contrast: 5,
            watershedLevel: 2, // 1:ä½, 2:ä¸­, 3:é«˜
            edgeTolerance: 70  // ç™¾åˆ†æ¯”
        };

        // OpenCVåŠ è½½å®Œæˆ
        function onOpenCvReady() {
            cvReady = true;
            console.log('OpenCV.js å·²å°±ç»ªï¼Œç‰ˆæœ¬:', cv.version);
            document.getElementById('processStep').textContent = 'OpenCV å¼•æ“å°±ç»ªï¼Œç­‰å¾…å›¾åƒ...';
        }

        // æ£€æŸ¥OpenCVåŠ è½½çŠ¶æ€
        const checkOpenCV = setInterval(() => {
            if (typeof cv !== 'undefined' && !cvReady) {
                onOpenCvReady();
                clearInterval(checkOpenCV);
            }
        }, 500);

        // æ‘„åƒå¤´å¤„ç†
        function openCamera() {
            document.getElementById('cameraInput').click();
        }

        // åŠ è½½ç¤ºä¾‹å›¾åƒ
        function loadSample() {
            const sampleImg = new Image();
            sampleImg.onload = function() {
                currentImage = sampleImg;
                processImage();
            };
            // åˆ›å»ºä¸€ä¸ªç®€å•çš„ç¤ºä¾‹å›¾åƒï¼ˆå®é™…åº”ç”¨ä¸­å¯æ›¿æ¢ä¸ºçœŸå®æ ·æœ¬ï¼‰
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;
            const ctx = canvas.getContext('2d');
            
            // ç»˜åˆ¶åŸ¹å…»çš¿èƒŒæ™¯
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, 800, 600);
            
            // ç»˜åˆ¶åŸ¹å…»çš¿åœ†å½¢
            ctx.strokeStyle = '#aaaaaa';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(400, 300, 250, 0, Math.PI * 2);
            ctx.stroke();
            
            // ç»˜åˆ¶æ¨¡æ‹ŸèŒè½
            const colors = ['#8B4513', '#A0522D', '#CD853F'];
            for (let i = 0; i < 45; i++) {
                const angle = Math.random() * Math.PI * 2;
                const distance = Math.random() * 220;
                const x = 400 + Math.cos(angle) * distance;
                const y = 300 + Math.sin(angle) * distance;
                const radius = Math.random() * 8 + 3;
                
                ctx.fillStyle = colors[Math.floor(Math.random() * colors.length)];
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                ctx.fill();
                
                // æ·»åŠ ä¸€äº›é»è¿èŒè½
                if (i < 5) {
                    ctx.beginPath();
                    ctx.arc(x + radius * 1.5, y, radius * 0.8, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            sampleImg.src = canvas.toDataURL('image/png');
        }

        // å¤„ç†ä¸Šä¼ çš„å›¾åƒ
        function handleImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('processStep').textContent = 'æ­£åœ¨è¯»å–å›¾åƒ...';
            updateProgress(10);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    currentImage = img;
                    processImage();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ä¸»å¤„ç†å‡½æ•°
        async function processImage() {
            if (!cvReady) {
                alert('OpenCVæ­£åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨å€™...');
                return;
            }

            if (!currentImage) return;

            // æ˜¾ç¤ºå¤„ç†çŠ¶æ€
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('processingStatus').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            
            processingStartTime = Date.now();
            
            // å¼‚æ­¥å¤„ç†ä»¥é¿å…é˜»å¡UI
            setTimeout(() => {
                try {
                    performDetection();
                } catch (error) {
                    console.error('å¤„ç†é”™è¯¯:', error);
                    alert('å¤„ç†å‡ºé”™: ' + error.message);
                    resetAll();
                }
            }, 100);
        }

        // ============================
        // æ ¸å¿ƒæ£€æµ‹ç®—æ³• - é›†æˆæ‰€æœ‰ä¼˜åŒ–
        // ============================
        function performDetection() {
            updateStep('è¯»å–å›¾åƒ...', 10);
            
            // 1. åŠ è½½å›¾åƒåˆ°OpenCV
            let src = cv.imread(currentImage);
            
            // æ€§èƒ½ä¼˜åŒ–ï¼šè°ƒæ•´å›¾åƒå°ºå¯¸
            const maxDim = 1200;
            let scale = 1;
            if (Math.max(src.cols, src.rows) > maxDim) {
                scale = maxDim / Math.max(src.cols, src.rows);
                let dsize = new cv.Size(Math.round(src.cols * scale), Math.round(src.rows * scale));
                cv.resize(src, src, dsize, 0, 0, cv.INTER_AREA);
            }
            
            updateStep('é¢œè‰²ç©ºé—´è½¬æ¢...', 20);
            
            // 2. è½¬æ¢åˆ°Labé¢œè‰²ç©ºé—´å¹¶å¢å¼ºLé€šé“
            let lab = new cv.Mat();
            cv.cvtColor(src, lab, cv.COLOR_RGB2Lab);
            let labPlanes = new cv.MatVector();
            cv.split(lab, labPlanes);
            let lChannel = labPlanes.get(0);
            
            // CLAHEå¯¹æ¯”åº¦å¢å¼º
            let clahe = new cv.CLAHE(4.0, new cv.Size(8, 8));
            let lEnhanced = new cv.Mat();
            clahe.apply(lChannel, lEnhanced);
            
            updateStep('åŠ¨æ€æ£€æµ‹åŸ¹å…»çš¿åŒºåŸŸ...', 30);
            
            // 3. ã€ä¼˜åŒ–1ã€‘åŠ¨æ€å¹³æ¿æ£€æµ‹
            let plateData = detectPlateRegion(lEnhanced);
            let plateMask = plateData.mask;
            detectedPlate = plateData.info;
            
            updateStep('åˆæ­¥èŒè½æ£€æµ‹ (LoG)...', 45);
            
            // 4. LoGæ–‘ç‚¹æ£€æµ‹
            let blobs = detectBlobsLoG(lEnhanced);
            
            updateStep('ç­›é€‰æœ‰æ•ˆåŒºåŸŸ...', 55);
            
            // 5. ä½¿ç”¨å¹³æ¿æ©ç ç­›é€‰
            let filteredBlobs = [];
            for (let blob of blobs) {
                // æ£€æŸ¥æ˜¯å¦åœ¨å¹³æ¿åŒºåŸŸå†…
                let maskValue = plateMask.ucharAt(Math.min(Math.round(blob.y), plateMask.rows-1), 
                                                 Math.min(Math.round(blob.x), plateMask.cols-1));
                if (maskValue > 128 && blob.r > params.minSigma && blob.r < params.maxSigma) {
                    filteredBlobs.push(blob);
                }
            }
            
            updateStep('å¤„ç†é»è¿èŒè½...', 65);
            
            // 6. ã€ä¼˜åŒ–2ã€‘é»è¿èŒè½åˆ†å‰²
            let segmentedBlobs = [];
            let largeBlobCount = 0;
            
            for (let blob of filteredBlobs) {
                // å¦‚æœblobåŠå¾„è¿‡å¤§æˆ–é¢ç§¯å¼‚å¸¸ï¼Œå¯èƒ½æ˜¯é»è¿èŒè½
                if (blob.r > params.minSigma * 3 && blob.response > 500) {
                    largeBlobCount++;
                    let subBlobs = applyWatershedToBlob(blob, lEnhanced, plateMask, params.watershedLevel);
                    segmentedBlobs.push(...subBlobs);
                } else {
                    segmentedBlobs.push(blob);
                }
            }
            
            updateStep('å»é™¤é‡å¤æ£€æµ‹ (NMS)...', 75);
            
            // 7. éæå¤§å€¼æŠ‘åˆ¶
            let nmsBlobs = nonMaxSuppression(segmentedBlobs, params.nmsDist);
            
            updateStep('éªŒè¯èŒè½è´¨é‡ (è¾¹ç¼˜ä¼˜åŒ–)...', 85);
            
            // 8. ã€ä¼˜åŒ–3ã€‘è¾¹ç¼˜å®½å®¹åº¦éªŒè¯
            let verificationResult = verifyBlobsWithEdgeTolerance(nmsBlobs, lEnhanced, plateMask, detectedPlate);
            let verifiedBlobs = verificationResult.blobs;
            let edgeCount = verificationResult.edgeCount;
            
            updateStep('ç»˜åˆ¶æ£€æµ‹ç»“æœ...', 95);
            
            // 9. ç»˜åˆ¶ç»“æœ
            let result = src.clone();
            
            // ç»˜åˆ¶åŸ¹å…»çš¿è¾¹ç•Œ
            cv.circle(result, 
                     new cv.Point(detectedPlate.centerX, detectedPlate.centerY), 
                     detectedPlate.radius, 
                     new cv.Scalar(255, 0, 0, 255), 2, cv.LINE_AA);
            
            // ç»˜åˆ¶èŒè½
            for (let i = 0; i < verifiedBlobs.length; i++) {
                let blob = verifiedBlobs[i];
                let color = new cv.Scalar(0, 0, 255, 255); // çº¢è‰²è½®å»“
                let center = new cv.Point(blob.x, blob.y);
                
                cv.circle(result, center, Math.round(blob.r), color, 2, cv.LINE_AA);
                cv.circle(result, center, 2, new cv.Scalar(0, 255, 0, 255), -1, cv.LINE_AA);
                
                // å¯é€‰ï¼šç»˜åˆ¶èŒè½ç¼–å·
                // cv.putText(result, (i+1).toString(), 
                //           new cv.Point(blob.x + 5, blob.y - 5),
                //           cv.FONT_HERSHEY_SIMPLEX, 0.4, 
                //           new cv.Scalar(0, 0, 0, 255), 1);
            }
            
            // æ˜¾ç¤ºç»“æœ
            cv.imshow('resultCanvas', result);
            currentResult = result;
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            const processTime = ((Date.now() - processingStartTime) / 1000).toFixed(2);
            document.getElementById('colonyCount').textContent = verifiedBlobs.length;
            document.getElementById('countTime').textContent = `åˆ†ææ—¶é—´: ${processTime}s`;
            document.getElementById('plateInfo').textContent = `å¹³æ¿åŠå¾„: ${detectedPlate.radius.toFixed(0)}px`;
            
            if (verifiedBlobs.length > 0) {
                let radii = verifiedBlobs.map(b => b.r);
                let totalArea = Math.PI * detectedPlate.radius * detectedPlate.radius;
                let colonyArea = radii.reduce((sum, r) => sum + Math.PI * r * r, 0);
                let density = verifiedBlobs.length / (totalArea / 10000); // æ¯å¹³æ–¹å˜ç±³
                
                document.getElementById('densityValue').textContent = `${density.toFixed(1)} /cmÂ²`;
                document.getElementById('avgRadius').textContent = (radii.reduce((a,b) => a+b, 0) / radii.length).toFixed(1) + ' px';
                document.getElementById('minRadius').textContent = Math.min(...radii).toFixed(1) + ' px';
                document.getElementById('maxRadius').textContent = Math.max(...radii).toFixed(1) + ' px';
                document.getElementById('plateArea').textContent = ((colonyArea / totalArea) * 100).toFixed(1) + ' %';
                document.getElementById('edgeCountInfo').textContent = `å·²å¯¹ ${edgeCount} ä¸ªè¾¹ç¼˜èŒè½åº”ç”¨å®½å®¹åº¦æ£€æµ‹`;
            }
            
            // é‡Šæ”¾å†…å­˜
            [src, lab, labPlanes, lChannel, lEnhanced, clahe, plateMask].forEach(m => {
                if (m && typeof m.delete === 'function') m.delete();
            });
            
            updateStep('åˆ†æå®Œæˆ!', 100);
            
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            setTimeout(() => {
                document.getElementById('processingStatus').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            }, 500);
        }

        // ============================
        // ã€ä¼˜åŒ–1ã€‘åŠ¨æ€å¹³æ¿æ£€æµ‹å‡½æ•°
        // ============================
        function detectPlateRegion(grayImg) {
            let mask = new cv.Mat.zeros(grayImg.rows, grayImg.cols, cv.CV_8UC1);
            let centerX = grayImg.cols / 2;
            let centerY = grayImg.rows / 2;
            let radius = Math.min(grayImg.cols, grayImg.rows) / 2 - 20;
            
            // æ–¹æ³•Aï¼šå°è¯•éœå¤«åœ†å˜æ¢
            let circles = new cv.Mat();
            let blurred = new cv.Mat();
            cv.GaussianBlur(grayImg, blurred, new cv.Size(5, 5), 2);
            
            cv.HoughCircles(blurred, circles, cv.HOUGH_GRADIENT,
                1.2,                    // dp
                grayImg.rows / 6,       // minDist
                100,                    // param1
                35,                     // param2
                Math.min(grayImg.rows, grayImg.cols) / 6, // minRadius
                Math.min(grayImg.rows, grayImg.cols) / 2  // maxRadius
            );
            
            if (circles.cols > 0) {
                let circleData = circles.data32F;
                centerX = circleData[0];
                centerY = circleData[1];
                radius = circleData[2] * 0.95; // ç¨å¾®ç¼©å°åŠå¾„ä»¥é¿å…è¾¹ç¼˜
                
                let center = new cv.Point(centerX, centerY);
                cv.circle(mask, center, radius, new cv.Scalar(255), -1);
                console.log(`éœå¤«åœ†æ£€æµ‹: ä¸­å¿ƒ(${centerX.toFixed(0)}, ${centerY.toFixed(0)}), åŠå¾„${radius.toFixed(0)}`);
            } else {
                // æ–¹æ³•Bï¼šåŸºäºè¾¹ç¼˜æ£€æµ‹çš„æœ€å¤§è½®å»“
                console.log('éœå¤«åœ†æœªæ£€å‡ºï¼Œä½¿ç”¨è¾¹ç¼˜æ£€æµ‹æ³•');
                let edges = new cv.Mat();
                cv.Canny(blurred, edges, 30, 100);
                
                // å½¢æ€å­¦æ“ä½œé—­åˆè¾¹ç¼˜
                let kernel = cv.getStructuringElement(cv.MORPH_ELLIPSE, new cv.Size(5, 5));
                cv.dilate(edges, edges, kernel);
                cv.erode(edges, edges, kernel);
                
                let contours = new cv.MatVector();
                let hierarchy = new cv.Mat();
                cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
                
                let maxArea = 0, maxContour = null;
                for (let i = 0; i < contours.size(); i++) {
                    let cnt = contours.get(i);
                    let area = cv.contourArea(cnt);
                    if (area > maxArea && area > grayImg.rows * grayImg.cols * 0.05) {
                        maxArea = area;
                        maxContour = cnt;
                    }
                }
                
                if (maxContour) {
                    // è·å–æœ€å°å¤–æ¥åœ†
                    let circle = cv.minEnclosingCircle(maxContour);
                    centerX = circle.center.x;
                    centerY = circle.center.y;
                    radius = circle.radius * 0.9;
                    
                    cv.circle(mask, new cv.Point(centerX, centerY), radius, new cv.Scalar(255), -1);
                    console.log(`è½®å»“æ£€æµ‹: ä¸­å¿ƒ(${centerX.toFixed(0)}, ${centerY.toFixed(0)}), åŠå¾„${radius.toFixed(0)}`);
                } else {
                    // æ–¹æ³•Cï¼šé»˜è®¤ä¸­å¿ƒåœ†å½¢
                    cv.circle(mask, new cv.Point(centerX, centerY), radius, new cv.Scalar(255), -1);
                    console.log('ä½¿ç”¨é»˜è®¤åœ†å½¢åŒºåŸŸ');
                }
                
                edges.delete(); kernel.delete(); contours.delete(); hierarchy.delete();
            }
            
            blurred.delete(); circles.delete();
            
            return {
                mask: mask,
                info: { centerX, centerY, radius }
            };
        }

        // ============================
        // LoGæ–‘ç‚¹æ£€æµ‹å‡½æ•°
        // ============================
        function detectBlobsLoG(grayImg) {
            let blobs = [];
            let sigmas = [];
            
            // åˆ›å»ºsigmaèŒƒå›´
            for (let s = params.minSigma; s <= params.maxSigma; s += (params.maxSigma - params.minSigma) / 8) {
                sigmas.push(s);
            }
            
            for (let sigma of sigmas) {
                let ksize = Math.round(sigma * 6) | 1;
                if (ksize < 3) ksize = 3;
                
                let blurred = new cv.Mat();
                let laplacian = new cv.Mat();
                
                cv.GaussianBlur(grayImg, blurred, new cv.Size(ksize, ksize), sigma);
                cv.Laplacian(blurred, laplacian, cv.CV_64F, 5);
                
                // è®¡ç®—ç»å¯¹æ‹‰æ™®æ‹‰æ–¯å“åº”
                let lapAbs = new cv.Mat();
                cv.convertScaleAbs(laplacian, lapAbs);
                
                // é˜ˆå€¼å¤„ç†
                let thresh = new cv.Mat();
                let thresholdValue = params.threshold * 255;
                cv.threshold(lapAbs, thresh, thresholdValue, 255, cv.THRESH_BINARY);
                
                // æŸ¥æ‰¾è½®å»“
                let contours = new cv.MatVector();
                let hierarchy = new cv.Mat();
                cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
                
                for (let i = 0; i < contours.size(); i++) {
                    let cnt = contours.get(i);
                    let area = cv.contourArea(cnt);
                    
                    // é¢ç§¯è¿‡æ»¤
                    if (area > 15 && area < 5000) {
                        let moments = cv.moments(cnt);
                        if (moments.m00 > 0) {
                            let cx = moments.m10 / moments.m00;
                            let cy = moments.m01 / moments.m00;
                            let r = Math.sqrt(area / Math.PI);
                            
                            // åœ†å½¢åº¦è¿‡æ»¤
                            let perimeter = cv.arcLength(cnt, true);
                            let circularity = (4 * Math.PI * area) / (perimeter * perimeter);
                            
                            if (circularity > 0.6) {
                                blobs.push({
                                    x: cx, 
                                    y: cy, 
                                    r: r, 
                                    sigma: sigma, 
                                    response: area * circularity,
                                    area: area
                                });
                            }
                        }
                    }
                }
                
                // é‡Šæ”¾å†…å­˜
                [blurred, laplacian, lapAbs, thresh, contours, hierarchy].forEach(m => m.delete());
            }
            
            return blobs;
        }

        // ============================
        // ã€ä¼˜åŒ–2ã€‘åˆ†æ°´å²­é»è¿åˆ†å‰²å‡½æ•°
        // ============================
        function applyWatershedToBlob(blob, grayImg, plateMask, intensityLevel) {
            let subBlobs = [];
            let roiSize = Math.round(blob.r * (intensityLevel === 3 ? 3.5 : intensityLevel === 2 ? 3.0 : 2.5));
            
            let x = Math.max(0, Math.round(blob.x - roiSize/2));
            let y = Math.max(0, Math.round(blob.y - roiSize/2));
            let w = Math.min(grayImg.cols - x, roiSize);
            let h = Math.min(grayImg.rows - y, roiSize);
            
            if (w <= 10 || h <= 10) return subBlobs;
            
            try {
                let roi = grayImg.roi(new cv.Rect(x, y, w, h));
                
                // 1. äºŒå€¼åŒ–
                let binary = new cv.Mat();
                cv.threshold(roi, binary, 0, 255, cv.THRESH_BINARY_INV + cv.THRESH_OTSU);
                
                // 2. å½¢æ€å­¦æ“ä½œ
                let kernelSize = intensityLevel === 3 ? 5 : intensityLevel === 2 ? 3 : 1;
                let kernel = cv.getStructuringElement(cv.MORPH_ELLIPSE, new cv.Size(kernelSize, kernelSize));
                
                let sureBg = new cv.Mat();
                cv.dilate(binary, sureBg, kernel, new cv.Point(-1, -1), 2);
                
                // 3. è·ç¦»å˜æ¢æ‰¾åˆ°å‰æ™¯
                let distTrans = new cv.Mat();
                cv.distanceTransform(binary, distTrans, cv.DIST_L2, 5);
                
                let sureFg = new cv.Mat();
                let maxVal = cv.minMaxLoc(distTrans).maxVal;
                cv.threshold(distTrans, sureFg, 0.3 * maxVal, 255, cv.THRESH_BINARY);
                sureFg.convertTo(sureFg, cv.CV_8U);
                
                // 4. æœªçŸ¥åŒºåŸŸ
                let unknown = new cv.Mat();
                cv.subtract(sureBg, sureFg, unknown);
                
                // 5. æ ‡è®°è¿é€šåŸŸ
                let markers = new cv.Mat();
                cv.connectedComponents(sureFg, markers);
                cv.add(markers, new cv.Scalar(1), markers);
                
                // 6. åº”ç”¨åˆ†æ°´å²­
                let roiColor = new cv.Mat();
                cv.cvtColor(roi, roiColor, cv.COLOR_GRAY2RGB);
                
                let markers32s = new cv.Mat();
                markers.convertTo(markers32s, cv.CV_32S);
                
                // è®¾ç½®æœªçŸ¥åŒºåŸŸä¸º0
                let unknown32s = new cv.Mat();
                unknown.convertTo(unknown32s, cv.CV_32S);
                cv.setTo(markers32s, new cv.Scalar(0), unknown32s);
                
                cv.watershed(roiColor, markers32s);
                
                // 7. æå–åˆ†å‰²ç»“æœ
                let markers8u = new cv.Mat();
                markers32s.convertTo(markers8u, cv.CV_8U);
                
                for (let markVal = 2; markVal <= cv.minMaxLoc(markers32s).maxVal; markVal++) {
                    let singleMask = new cv.Mat();
                    cv.compare(markers32s, new cv.Scalar(markVal), singleMask, cv.CMP_EQ);
                    
                    let contours = new cv.MatVector();
                    let hierarchy = new cv.Mat();
                    cv.findContours(singleMask, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
                    
                    if (contours.size() > 0) {
                        let cnt = contours.get(0);
                        let area = cv.contourArea(cnt);
                        
                        if (area > 20 && area < blob.area * 0.9) {
                            let M = cv.moments(cnt);
                            if (M.m00 > 0) {
                                let cx = x + (M.m10 / M.m00);
                                let cy = y + (M.m01 / M.m00);
                                let r = Math.sqrt(area / Math.PI);
                                
                                // æ£€æŸ¥æ˜¯å¦åœ¨å¹³æ¿åŒºåŸŸå†…
                                let maskValue = 255;
                                if (plateMask) {
                                    maskValue = plateMask.ucharAt(
                                        Math.min(Math.round(cy), plateMask.rows-1), 
                                        Math.min(Math.round(cx), plateMask.cols-1)
                                    );
                                }
                                
                                if (maskValue > 128) {
                                    subBlobs.push({
                                        x: cx, 
                                        y: cy, 
                                        r: r, 
                                        response: area,
                                        area: area,
                                        fromWatershed: true
                                    });
                                }
                            }
                        }
                    }
                    
                    contours.delete(); hierarchy.delete(); singleMask.delete();
                }
                
                // é‡Šæ”¾å†…å­˜
                [roi, binary, kernel, sureBg, distTrans, sureFg, unknown, markers, roiColor, markers32s, unknown32s, markers8u].forEach(m => {
                    if (m && typeof m.delete === 'function') m.delete();
                });
                
            } catch (error) {
                console.warn('åˆ†æ°´å²­åˆ†å‰²å¤±è´¥:', error);
            }
            
            return subBlobs.length > 0 ? subBlobs : [blob]; // å¦‚æœåˆ†å‰²å¤±è´¥ï¼Œè¿”å›åŸå§‹blob
        }

        // ============================
        // éæå¤§å€¼æŠ‘åˆ¶å‡½æ•°
        // ============================
        function nonMaxSuppression(blobs, distThresh) {
            if (blobs.length === 0) return [];
            
            // æŒ‰å“åº”å€¼æ’åº
            blobs.sort((a, b) => b.response - a.response);
            
            let keep = [];
            for (let blob of blobs) {
                let isDuplicate = false;
                
                for (let kept of keep) {
                    let dx = blob.x - kept.x;
                    let dy = blob.y - kept.y;
                    let dist = Math.sqrt(dx*dx + dy*dy);
                    
                    if (dist < distThresh) {
                        isDuplicate = true;
                        break;
                    }
                }
                
                if (!isDuplicate) {
                    keep.push(blob);
                }
            }
            
            return keep;
        }

        // ============================
        // ã€ä¼˜åŒ–3ã€‘è¾¹ç¼˜å®½å®¹åº¦éªŒè¯å‡½æ•°
        // ============================
        function verifyBlobsWithEdgeTolerance(blobs, grayImg, plateMask, plateInfo) {
            let verified = [];
            let edgeCount = 0;
            
            let centerX = plateInfo.centerX;
            let centerY = plateInfo.centerY;
            let radius = plateInfo.radius;
            let edgeThreshold = radius * 0.85; // 85%åŠå¾„ä»¥å¤–è§†ä¸ºè¾¹ç¼˜
            
            for (let blob of blobs) {
                let x = Math.round(blob.x);
                let y = Math.round(blob.y);
                let r = Math.max(1, Math.round(blob.r * 0.8));
                
                // è¾¹ç•Œæ£€æŸ¥
                if (y - r < 0 || y + r >= grayImg.rows || x - r < 0 || x + r >= grayImg.cols) {
                    continue;
                }
                
                // è·å–ROI
                let roi = grayImg.roi(new cv.Rect(x - r, y - r, 2*r, 2*r));
                
                // è®¡ç®—ä¸­å¿ƒå’Œè¾¹ç¼˜å¼ºåº¦
                let centerSum = 0, centerCount = 0;
                let edgeSum = 0, edgeCountPixels = 0;
                
                for (let i = 0; i < roi.rows; i++) {
                    for (let j = 0; j < roi.cols; j++) {
                        let px = roi.ucharAt(i, j);
                        let dx = j - r;
                        let dy = i - r;
                        let d = Math.sqrt(dx*dx + dy*dy);
                        
                        if (d < r * 0.5) {
                            centerSum += px;
                            centerCount++;
                        } else if (d > r * 0.8 && d < r * 1.2) {
                            edgeSum += px;
                            edgeCountPixels++;
                        }
                    }
                }
                
                roi.delete();
                
                if (centerCount === 0 || edgeCountPixels === 0) continue;
                
                let centerMean = centerSum / centerCount;
                let edgeMean = edgeSum / edgeCountPixels;
                let contrast = centerMean - edgeMean;
                
                // åˆ¤æ–­æ˜¯å¦ä¸ºè¾¹ç¼˜èŒè½
                let dx = blob.x - centerX;
                let dy = blob.y - centerY;
                let distFromCenter = Math.sqrt(dx*dx + dy*dy);
                let isAtEdge = distFromCenter > edgeThreshold;
                
                // åº”ç”¨ä¸åŒçš„é˜ˆå€¼
                let intensityThreshold = params.intensity;
                let contrastThreshold = params.contrast;
                
                if (isAtEdge) {
                    edgeCount++;
                    let tolerance = params.edgeTolerance / 100; // è½¬æ¢ä¸ºç³»æ•°
                    intensityThreshold = params.intensity * (0.5 + tolerance * 0.5); // 50%-100%
                    contrastThreshold = params.contrast * (0.3 + tolerance * 0.7);   // 30%-100%
                }
                
                // éªŒè¯
                if (centerMean > intensityThreshold && contrast > contrastThreshold) {
                    verified.push(blob);
                }
            }
            
            return {
                blobs: verified,
                edgeCount: edgeCount
            };
        }

        // ============================
        // UIè¾…åŠ©å‡½æ•°
        // ============================
        function updateStep(text, progress = null) {
            document.getElementById('processStep').textContent = text;
            if (progress !== null) {
                updateProgress(progress);
            }
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${Math.round(percent)}%`;
        }

        function toggleParams() {
            const section = document.getElementById('paramSection');
            const arrow = document.getElementById('paramArrow');
            section.classList.toggle('hidden');
            arrow.classList.toggle('rotate-180');
        }

        function toggleOverlay() {
            showOriginal = !showOriginal;
            const btn = document.getElementById('toggleOverlayBtn');
            
            if (showOriginal && currentImage) {
                // æ˜¾ç¤ºåŸå›¾
                const canvas = document.getElementById('resultCanvas');
                const ctx = canvas.getContext('2d');
                ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
                btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L6.59 6.59m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path></svg> æ˜¾ç¤ºç»“æœ`;
            } else if (currentResult) {
                // æ˜¾ç¤ºæ£€æµ‹ç»“æœ
                cv.imshow('resultCanvas', currentResult);
                btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg> æ˜¾ç¤ºåŸå›¾`;
            }
        }

        function updateParam(name, value) {
            params[name] = parseFloat(value);
            const valElement = document.getElementById(name + 'Val');
            
            // ç‰¹æ®Šæ ¼å¼åŒ–æ˜¾ç¤º
            switch(name) {
                case 'minSigma':
                case 'maxSigma':
                case 'nmsDist':
                    valElement.textContent = value + ' åƒç´ ';
                    break;
                case 'threshold':
                    valElement.textContent = parseFloat(value).toFixed(2);
                    break;
                case 'watershedLevel':
                    const levels = ['ä½', 'ä¸­', 'é«˜'];
                    valElement.textContent = levels[value-1] || 'ä¸­';
                    break;
                case 'edgeTolerance':
                    valElement.textContent = value + '%';
                    break;
                default:
                    valElement.textContent = value;
            }
        }

        function resetParams() {
            params = {
                minSigma: 2.5,
                maxSigma: 15,
                threshold: 0.04,
                nmsDist: 12,
                intensity: 120,
                contrast: 5,
                watershedLevel: 2,
                edgeTolerance: 70
            };
            
            // æ›´æ–°æ»‘å—æ˜¾ç¤º
            document.getElementById('minSigma').value = params.minSigma;
            document.getElementById('maxSigma').value = params.maxSigma;
            document.getElementById('threshold').value = params.threshold;
            document.getElementById('nmsDist').value = params.nmsDist;
            document.getElementById('watershedLevel').value = params.watershedLevel;
            document.getElementById('edgeTolerance').value = params.edgeTolerance;
            
            // æ›´æ–°æ•°å€¼æ˜¾ç¤º
            updateParam('minSigma', params.minSigma);
            updateParam('maxSigma', params.maxSigma);
            updateParam('threshold', params.threshold);
            updateParam('nmsDist', params.nmsDist);
            updateParam('watershedLevel', params.watershedLevel);
            updateParam('edgeTolerance', params.edgeTolerance);
            
            // é‡æ–°å¤„ç†
            if (currentImage) {
                reprocess();
            }
        }

        function reprocess() {
            if (currentImage) {
                processImage();
            }
        }

        function resetAll() {
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('processingStatus').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('fileInput').value = '';
            document.getElementById('cameraInput').value = '';
            
            currentImage = null;
            showOriginal = false;
            
            if (currentResult) {
                currentResult.delete();
                currentResult = null;
            }
        }

        function downloadResult() {
            const canvas = document.getElementById('resultCanvas');
            const link = document.createElement('a');
            link.download = `èŒè½è®¡æ•°_${new Date().getFullYear()}${(new Date().getMonth()+1).toString().padStart(2,'0')}${new Date().getDate().toString().padStart(2,'0')}_${new Date().getHours().toString().padStart(2,'0')}${new Date().getMinutes().toString().padStart(2,'0')}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function exportData() {
            // è¿™é‡Œå¯ä»¥æ·»åŠ å¯¼å‡ºCSVæ•°æ®çš„åŠŸèƒ½
            alert('æ•°æ®å¯¼å‡ºåŠŸèƒ½éœ€æ ¹æ®å®é™…èŒè½æ•°æ®å®ç°');
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            console.log('èŒè½è®¡æ•°å™¨ Pro (ä¼˜åŒ–ç‰ˆ) å·²åŠ è½½');
            console.log('ä¼˜åŒ–åŠŸèƒ½: åŠ¨æ€å¹³æ¿æ£€æµ‹ | é»è¿åˆ†å‰² | è¾¹ç¼˜æŠ˜å°„ä¼˜åŒ–');
        };
    </script>
</body>
</html>
